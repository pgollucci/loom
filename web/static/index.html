<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loom - Autonomous Agent Orchestration</title>
    <link rel="stylesheet" href="/static/css/style.css?v=8">
    <script src="/static/js/diagnostic.js?v=6"></script>
    <link rel="stylesheet" href="/static/css/bootstrap.css?v=4">
    <script src="/static/js/bootstrap.js"></script>
    <script src="/static/js/projects-table.js"></script>
    <script src="/static/js/conversations.js"></script>
    <script src="/static/js/create-bead.js"></script>
    <script src="/static/js/file-locks.js"></script>
    <script src="/static/js/pair.js?v=1"></script>
</head>
<body>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <header>
        <div class="header-top">
            <h1><span aria-hidden="true">üßµ</span> Loom - Autonomous Agent Orchestration</h1>
            <div style="display:flex;align-items:center;gap:0.5rem;">
                <span id="health-pill" title="Backend: checking..." style="display:inline-block;padding:0.25rem 0.75rem;border-radius:999px;font-size:0.8rem;font-weight:600;cursor:default;background:#888;color:#fff;">...</span>
                <div class="observability-menu" style="position:relative;">
                    <button type="button" class="icon-button" id="observability-btn" title="Observability Stack" aria-label="Open observability menu" onclick="toggleObservabilityMenu()">üëÅÔ∏è</button>
                    <div id="observability-dropdown" class="dropdown-menu" style="display:none;position:absolute;right:0;top:100%;margin-top:0.25rem;background:#fff;border:1px solid #ddd;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:200px;z-index:1000;">
                        <a href="http://localhost:3080" target="_blank" style="display:block;padding:0.5rem 1rem;text-decoration:none;color:#333;border-bottom:1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                            üåê Loom UI
                        </a>
                        <a href="http://localhost:3000" target="_blank" style="display:block;padding:0.5rem 1rem;text-decoration:none;color:#333;border-bottom:1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                            üìä Grafana
                        </a>
                        <a href="http://localhost:16686" target="_blank" style="display:block;padding:0.5rem 1rem;text-decoration:none;color:#333;border-bottom:1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                            üîç Jaeger
                        </a>
                        <a href="http://localhost:9090" target="_blank" style="display:block;padding:0.5rem 1rem;text-decoration:none;color:#333;border-bottom:1px solid #eee;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                            üìà Prometheus
                        </a>
                        <a href="http://localhost:8080" target="_blank" style="display:block;padding:0.5rem 1rem;text-decoration:none;color:#333;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                            ‚è±Ô∏è Temporal UI
                        </a>
                    </div>
                </div>
                <button type="button" class="icon-button" id="password-btn" onclick="showChangePasswordModal()" title="Change password" aria-label="Change password">üîê</button>
            </div>
        </div>
        <div id="system-status" class="system-status" aria-live="polite" aria-atomic="true"></div>
        <nav aria-label="Primary">
            <ul class="nav-list">
                <li><a href="#project-viewer" aria-label="Jump to Project Viewer section">Project Viewer</a></li>
                <li><a href="#kanban" aria-label="Jump to Kanban Board section">Kanban Board</a></li>
                <li><a href="/static/workflows.html" aria-label="View Workflow System">Workflows</a></li>
                <li><a href="#providers" aria-label="Jump to Providers section">Providers</a></li>
                <li><a href="#agents" aria-label="Jump to Agents section">Agents</a></li>
                <li><a href="#decisions" aria-label="Jump to Decisions section">Decisions</a></li>
                <li><a href="#ceo-dashboard" aria-label="Jump to CEO Dashboard section">CEO Dashboard</a></li>
                <li><a href="#personas" aria-label="Jump to Personas section">Personas</a></li>
                <li><a href="#projects" aria-label="Jump to Projects section">Projects</a></li>
                <li><a href="#repl" aria-label="Jump to CEO REPL section">CEO REPL</a></li>
                <li><a href="#streaming-test" aria-label="Jump to Streaming Test section">Streaming Test</a></li>
                <li><a href="#users" aria-label="Jump to Users section">Users</a></li>
                <li><a href="#analytics" aria-label="Jump to Analytics section">Analytics</a></li>
                <li><a href="#motivations" aria-label="Jump to Motivations section">Motivations</a></li>
                <li><a href="#diagrams" aria-label="Jump to Diagrams section">Diagrams</a></li>
            </ul>
        </nav>
    </header>

    <main id="main-content">
        <div class="view-tabs" role="tablist" aria-label="UI sections">
            <!-- Home -->
            <button class="view-tab active" data-target="project-viewer" role="tab" aria-selected="true">üè† Home</button>

            <!-- Work -->
            <button class="view-tab" data-target="kanban" role="tab" aria-selected="false">üìã Kanban</button>
            <button class="view-tab" data-target="decisions" role="tab" aria-selected="false">‚öñÔ∏è Decisions</button>

            <!-- Team -->
            <button class="view-tab" data-target="agents" role="tab" aria-selected="false">ü§ñ Agents</button>
            <button class="view-tab" data-target="personas" role="tab" aria-selected="false">üé≠ Personas</button>
            <button class="view-tab" data-target="users" role="tab" aria-selected="false">üë• Users</button>

            <!-- Projects & Infrastructure -->
            <button class="view-tab" data-target="projects" role="tab" aria-selected="false">üìÅ Projects</button>
            <button class="view-tab" data-target="providers" role="tab" aria-selected="false">üîå Providers</button>
            <button class="view-tab" data-target="conversations" role="tab" aria-selected="false">üí¨ Conversations</button>

            <!-- Admin & Monitoring -->
            <button class="view-tab" data-target="ceo" role="tab" aria-selected="false">üß≠ CEO</button>
            <button class="view-tab" data-target="analytics" role="tab" aria-selected="false">üìä Analytics</button>
            <button class="view-tab" data-target="motivations" role="tab" aria-selected="false">‚ö° Motivations</button>
            <button class="view-tab" data-target="logs" role="tab" aria-selected="false">üìã Logs</button>

            <!-- Debug & Dev -->
            <button class="view-tab" data-target="diagrams" role="tab" aria-selected="false">üìä Diagrams</button>
            <button class="view-tab" data-target="dev-tools" role="tab" aria-selected="false">üîß Dev Tools</button>
        </div>

        <!-- Project Viewer Section -->
        <section id="project-viewer" class="view-panel active" role="tabpanel" aria-label="Project Viewer">
            <h2><span aria-hidden="true">üìÅ</span> Project Viewer</h2>
            <div class="toolbar" role="region" aria-label="Project viewer controls">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="project-view-select">Project</label>
                        <select id="project-view-select"></select>
                    </div>
                    <div class="field">
                        <button type="button" class="secondary" id="project-view-add" onclick="showProjectOptionsMenu()" aria-haspopup="dialog">Add Project</button>
                    </div>
                </div>
            </div>
            <div id="project-view-details" class="project-view-details"></div>

            <!-- D3 dashboard overview -->
            <div class="analytics-summary" style="margin: 1rem 0;">
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Agent Status</h3>
                    <div id="d3-home-agent-ring"></div>
                </div>
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Bead Distribution</h3>
                    <div id="d3-home-bead-treemap" style="width:100%;"></div>
                </div>
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Provider Health</h3>
                    <div id="d3-home-provider-ring"></div>
                </div>
            </div>

            <h3>Beads</h3>
            <div class="kanban-container">
                <div class="kanban-column">
                    <h4>Open</h4>
                    <div id="project-open-beads" class="bead-list"></div>
                </div>
                <div class="kanban-column">
                    <h4>In Progress</h4>
                    <div id="project-in-progress-beads" class="bead-list"></div>
                </div>
                <div class="kanban-column">
                    <h4>Closed</h4>
                    <div id="project-closed-beads" class="bead-list"></div>
                </div>
            </div>

            <h3>Agent assignments</h3>
            <div id="project-agent-assignments" class="assignment-board"></div>
        </section>

        <!-- Kanban Board Section -->
        <section id="kanban" class="view-panel" role="tabpanel" aria-label="Kanban Board" hidden>
            <h2><span aria-hidden="true">üìã</span> Kanban Board</h2>
            <div class="toolbar" role="region" aria-label="Bead controls">
                <button type="button" class="primary" onclick="showCreateBeadModal()" aria-haspopup="dialog">Create Bead</button>
            </div>
            <div class="toolbar" role="region" aria-label="Bead search and filters">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="bead-search">Search beads</label>
                        <input type="text" id="bead-search" placeholder="Search by title, description, id‚Ä¶" autocomplete="off">
                    </div>
                    <div class="field">
                        <label for="bead-sort">Sort</label>
                        <select id="bead-sort">
                            <option value="priority">Priority</option>
                            <option value="updated_at">Recently updated</option>
                            <option value="title">Title</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="bead-priority">Priority</label>
                        <select id="bead-priority">
                            <option value="all">All</option>
                            <option value="0">P0</option>
                            <option value="1">P1</option>
                            <option value="2">P2</option>
                            <option value="3">P3</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="bead-type">Type</label>
                        <select id="bead-type">
                            <option value="all">All</option>
                            <option value="task">task</option>
                            <option value="decision">decision</option>
                            <option value="epic">epic</option>
                        </select>
                    </div>
                </div>
                <div class="toolbar-row">
                    <div class="field">
                        <label for="bead-project">Project</label>
                        <select id="bead-project">
                            <option value="all">All Projects</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="bead-assigned">Assigned to</label>
                        <input type="text" id="bead-assigned" placeholder="agent id / user id‚Ä¶" autocomplete="off">
                    </div>
                    <div class="field">
                        <label for="bead-tag">Tag</label>
                        <input type="text" id="bead-tag" placeholder="tag‚Ä¶" autocomplete="off">
                    </div>
                    <div class="field">
                        <button type="button" class="secondary" id="bead-clear-filters">Clear filters</button>
                    </div>
                </div>
            </div>
            <div class="kanban-container">
                <div class="kanban-column kanban-dropzone" data-status="open">
                    <h3>Open</h3>
                    <div id="open-beads" class="bead-list">
                        <!-- Beads will be loaded here -->
                    </div>
                </div>
                <div class="kanban-column kanban-dropzone" data-status="in_progress">
                    <h3>In Progress</h3>
                    <div id="in-progress-beads" class="bead-list">
                        <!-- Beads will be loaded here -->
                    </div>
                </div>
                <div class="kanban-column kanban-dropzone" data-status="closed">
                    <h3>Closed</h3>
                    <div id="closed-beads" class="bead-list">
                        <!-- Beads will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Decision Beads Section -->
        <section id="decisions" class="view-panel" role="tabpanel" aria-label="Decisions" hidden>
            <h2><span aria-hidden="true">‚öñÔ∏è</span> Decision Beads</h2>
            <div id="decision-list" class="decision-container">
                <!-- Decision beads will be loaded here -->
            </div>
        </section>

        <!-- Combined CEO Section -->
        <section id="ceo" class="view-panel" role="tabpanel" aria-label="CEO Command Center" hidden>
            <h2><span aria-hidden="true">üß≠</span> CEO Command Center</h2>

            <!-- Dashboard Summary -->
            <h3>Dashboard Overview</h3>
            <div id="ceo-dashboard-summary" class="ceo-dashboard-grid"></div>

            <!-- CEO REPL -->
            <h3 style="margin-top: 2rem;">CEO REPL</h3>
            <div class="repl-container">
                <label for="ceo-repl-input">Ask Loom</label>
                <textarea id="ceo-repl-input" rows="4" placeholder="Ask a question, or dispatch: agent name: task description"></textarea>
                <div class="controls" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="ceo-repl-stream-toggle" checked>
                        <label for="ceo-repl-stream-toggle" style="margin: 0; font-size: 0.9rem;">Enable streaming</label>
                    </div>
                    <button type="button" id="ceo-repl-send">Send</button>
                </div>
                <div id="ceo-repl-response" class="repl-response" aria-live="polite"></div>
            </div>

            <!-- CEO Assigned Beads -->
            <div class="ceo-beads-panel" role="region" aria-label="CEO assigned beads">
                <h3>Assigned to CEO</h3>
                <div id="ceo-assigned-beads-unified" class="ceo-beads-list"></div>
            </div>
        </section>

        <!-- Providers Section -->
        <section id="providers" class="view-panel" role="tabpanel" aria-label="Providers" hidden>
            <h2><span aria-hidden="true">üîå</span> Providers</h2>
            <div class="controls">
                <button type="button" onclick="showRegisterProviderModal()" aria-haspopup="dialog">Register Provider</button>
            </div>
            <div class="analytics-summary" style="margin-bottom: 1rem;">
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Health Overview</h3>
                    <div id="d3-providers-health-ring"></div>
                </div>
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Heartbeat Latency</h3>
                    <div id="d3-providers-latency-bar" class="chart" style="width:100%;"></div>
                </div>
            </div>
            <div id="provider-list" class="provider-container">
                <!-- Providers will be loaded here -->
            </div>
        </section>

        <!-- Agents Section -->
        <section id="agents" class="view-panel" role="tabpanel" aria-label="Agents" hidden>
            <h2><span aria-hidden="true">ü§ñ</span> Active Agents</h2>
            <div class="controls">
                <button type="button" onclick="showSpawnAgentModal()" aria-haspopup="dialog" aria-controls="spawn-agent-modal">Spawn New Agent</button>
            </div>
            <div class="toolbar" role="region" aria-label="Agent search">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="agent-search">Search agents</label>
                        <input type="text" id="agent-search" placeholder="Search by name or persona‚Ä¶" autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="analytics-summary" style="margin-bottom: 1rem;">
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Status Overview</h3>
                    <div id="d3-agents-status-ring"></div>
                </div>
                <div class="analytics-card" style="display:flex;flex-direction:column;align-items:center;">
                    <h3>Workload by Agent</h3>
                    <div id="d3-agents-workload-donut"></div>
                </div>
            </div>
            <div id="agent-list" class="agent-container">
                <!-- Agents will be loaded here -->
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="view-panel" role="tabpanel" aria-label="Projects" hidden>
            <h2><span aria-hidden="true">üìÅ</span> Projects</h2>
            <div class="controls">
                <button type="button" onclick="showProjectOptionsMenu()" aria-haspopup="dialog">Add Project</button>
            </div>
            <div id="projects-table-container">
                <!-- Projects table will be loaded here -->
            </div>
            <div id="project-list" class="project-container" style="display: none;">
                <!-- Legacy project list (kept for backward compatibility) -->
            </div>
        </section>

        <!-- Conversations Section -->
        <section id="conversations" class="view-panel" role="tabpanel" aria-label="Conversations" hidden>
            <h2><span aria-hidden="true">üí¨</span> Agent Conversations</h2>
            <p class="small" style="margin-bottom: 1rem;">Interactive action-flow graph. Click a node to see details. Zoom and pan to explore.</p>
            <div class="toolbar" role="region" aria-label="Conversation controls">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="conv-project-select">Project</label>
                        <select id="conv-project-select"></select>
                    </div>
                    <div class="field">
                        <label for="conv-select">Conversation</label>
                        <select id="conv-select"></select>
                    </div>
                    <button type="button" class="secondary" id="conv-reset-view" title="Reset graph view">Reset View</button>
                </div>
            </div>
            <div id="conversations-container" class="conv-graph-layout">
                <div id="conv-graph" class="conv-graph-canvas"></div>
                <div id="conv-detail" class="conv-detail-panel">
                    <div class="empty-state"><p>Select a node in the graph</p></div>
                </div>
            </div>
            <div id="conv-legend" class="conv-legend">
                <span><span class="conv-legend-dot" style="background:#16a34a;"></span> Success</span>
                <span><span class="conv-legend-dot" style="background:#dc2626;"></span> Error</span>
                <span><span class="conv-legend-dot" style="background:#d97706;"></span> Text / Parse fail</span>
                <span><span class="conv-legend-dot" style="background:#2563eb;"></span> System</span>
                <span><span class="conv-legend-dot" style="background:#7c3aed;"></span> Done / Commit</span>
            </div>
        </section>

        <!-- Personas Section -->
        <section id="personas" class="view-panel" role="tabpanel" aria-label="Personas" hidden>
            <h2><span aria-hidden="true">üé≠</span> Personas</h2>
            <div id="persona-list" class="persona-container">
                <!-- Personas will be loaded here -->
            </div>
        </section>

        <!-- Legacy REPL section - kept for backward compatibility but hidden by default -->
        <section id="repl" class="view-panel" role="tabpanel" aria-label="CEO REPL (Legacy)" hidden style="display: none;">
            <!-- Content moved to unified CEO section -->
        </section>

        <!-- Logs Section -->
        <section id="logs" class="view-panel" role="tabpanel" aria-label="System Logs" hidden>
            <h2><span aria-hidden="true">üìã</span> System Logs & Metrics</h2>
            
            <!-- Metrics Panel -->
            <div id="log-metrics" class="log-metrics"></div>
            
            <!-- Log Controls -->
            <div class="toolbar" role="region" aria-label="Log controls">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="log-level-filter">Level</label>
                        <select id="log-level-filter">
                            <option value="">All</option>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warn">Warn</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="log-source-filter">Source</label>
                        <select id="log-source-filter">
                            <option value="">All</option>
                            <option value="loom">Loom</option>
                            <option value="temporal">Temporal</option>
                            <option value="agent">Agent</option>
                            <option value="provider">Provider</option>
                            <option value="dispatcher">Dispatcher</option>
                            <option value="database">Database</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="log-search">Search</label>
                        <input type="text" id="log-search" placeholder="Search messages..." autocomplete="off">
                    </div>
                    <div class="field">
                        <label><input type="checkbox" id="log-autoscroll" checked> Auto-scroll</label>
                    </div>
                    <div class="field">
                        <button type="button" onclick="logViewer.clearLogs()">Clear</button>
                        <button type="button" onclick="logViewer.exportLogs()">Export</button>
                    </div>
                </div>
            </div>
            
            <!-- Log Viewer -->
            <div id="log-viewer" class="log-viewer"></div>
        </section>

        <!-- Dev Tools Section -->
        <section id="dev-tools" class="view-panel" role="tabpanel" aria-label="Developer Tools" hidden>
            <h2><span aria-hidden="true">üîß</span> Developer Tools</h2>
            <p class="small" style="margin-bottom: 1rem;">Debugging and testing utilities for developers.</p>

            <!-- Streaming Test -->
            <div class="dev-tool-section">
                <h3><span aria-hidden="true">‚ö°</span> Streaming Test</h3>
                <p class="small" style="margin-bottom: 1rem;">Test real-time streaming responses from AI providers.</p>
            <div class="repl-container">
                <div class="field">
                    <label for="stream-test-provider">Provider</label>
                    <select id="stream-test-provider">
                        <option value="">Select a provider...</option>
                    </select>
                </div>
                <label for="stream-test-input">Message</label>
                <textarea id="stream-test-input" rows="3" placeholder="Enter a message to test streaming‚Ä¶">Write a haiku about AI agents.</textarea>
                <div class="controls" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                    <div>
                        <label class="small" style="margin: 0;">
                            <input type="checkbox" id="stream-test-streaming" checked> Enable streaming
                        </label>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" id="stream-test-send" class="primary">Send</button>
                        <button type="button" id="stream-test-clear" class="secondary">Clear</button>
                    </div>
                </div>
                <div id="stream-test-stats" class="small" style="color: var(--text-muted); margin-top: 0.5rem;"></div>
                <div id="stream-test-response" class="repl-response" aria-live="polite"></div>
            </div>
            </div>

            <!-- File Locks -->
            <div class="dev-tool-section" style="margin-top: 2rem;">
                <h3><span aria-hidden="true">üîí</span> File Locks</h3>
                <p class="small" style="margin-bottom: 1rem;">View active file locks across the system.</p>
                <div class="toolbar">
                    <button type="button" id="refresh-file-locks-btn" class="secondary">Refresh</button>
                </div>
                <div id="file-locks-container">
                    <!-- File locks will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Legacy Streaming Test section - kept for backward compatibility -->
        <section id="streaming-test" class="view-panel" role="tabpanel" aria-label="Streaming Test (Legacy)" hidden style="display: none;">
            <!-- Content moved to dev-tools section -->
        </section>

        <!-- Users Section -->
        <section id="users" class="view-panel" role="tabpanel" aria-label="Users" hidden>
            <h2><span aria-hidden="true">üë•</span> User Management</h2>
            <p class="small" style="margin-bottom: 1rem;">Manage users, roles, and API keys. (Admin only)</p>
            
            <div class="toolbar">
                <button type="button" id="create-user-btn" class="primary">Create User</button>
                <button type="button" id="refresh-users-btn" class="secondary">Refresh</button>
            </div>

            <div id="users-list"></div>

            <!-- Create User Form (hidden by default) -->
            <div id="create-user-form" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary);">
                <h3>Create New User</h3>
                <form id="user-form">
                    <div class="field">
                        <label for="user-username">Username *</label>
                        <input type="text" id="user-username" required>
                    </div>
                    <div class="field">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email">
                    </div>
                    <div class="field">
                        <label for="user-password">Password *</label>
                        <input type="password" id="user-password" required>
                    </div>
                    <div class="field">
                        <label for="user-role">Role *</label>
                        <select id="user-role" required>
                            <option value="admin">Admin - Full system access</option>
                            <option value="user" selected>User - Read/write access</option>
                            <option value="viewer">Viewer - Read-only access</option>
                            <option value="service">Service - API key only</option>
                        </select>
                    </div>
                    <div class="controls">
                        <button type="submit" class="primary">Create User</button>
                        <button type="button" id="cancel-user-btn" class="secondary">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- API Keys Section -->
            <div style="margin-top: 2rem;">
                <h3><span aria-hidden="true">üîë</span> My API Keys</h3>
                <p class="small">Manage your personal API keys for programmatic access.</p>
                
                <div class="toolbar">
                    <button type="button" id="create-apikey-btn" class="primary">Generate API Key</button>
                </div>
                
                <div id="apikeys-list"></div>

                <!-- Create API Key Form -->
                <div id="create-apikey-form" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary);">
                    <h4>Generate New API Key</h4>
                    <form id="apikey-form">
                        <div class="field">
                            <label for="apikey-name">Key Name *</label>
                            <input type="text" id="apikey-name" placeholder="e.g., CI/CD Pipeline" required>
                        </div>
                        <div class="field">
                            <label for="apikey-permissions">Permissions</label>
                            <select id="apikey-permissions" multiple size="6">
                                <option value="*:*">*:* - All permissions</option>
                                <option value="agents:read">agents:read</option>
                                <option value="agents:write">agents:write</option>
                                <option value="beads:read" selected>beads:read</option>
                                <option value="beads:write" selected>beads:write</option>
                                <option value="providers:read">providers:read</option>
                                <option value="projects:read">projects:read</option>
                            </select>
                            <p class="small">Hold Ctrl/Cmd to select multiple</p>
                        </div>
                        <div class="field">
                            <label for="apikey-expires">Expires In</label>
                            <select id="apikey-expires">
                                <option value="0">Never</option>
                                <option value="86400">1 day</option>
                                <option value="604800">7 days</option>
                                <option value="2592000" selected>30 days</option>
                                <option value="7776000">90 days</option>
                                <option value="31536000">1 year</option>
                            </select>
                        </div>
                        <div class="controls">
                            <button type="submit" class="primary">Generate Key</button>
                            <button type="button" id="cancel-apikey-btn" class="secondary">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- API Key Display (shown after creation) -->
                <div id="apikey-display" style="display: none; margin-top: 1rem; padding: 1rem; border: 2px solid var(--success-color); border-radius: 4px; background: var(--bg-secondary);">
                    <h4 style="color: var(--success-color);">‚úì API Key Created</h4>
                    <p><strong>Save this key now - it will only be shown once!</strong></p>
                    <div style="font-family: monospace; background: var(--bg-primary); padding: 1rem; margin: 0.5rem 0; border-radius: 4px; word-break: break-all;">
                        <code id="apikey-value" style="user-select: all;"></code>
                    </div>
                    <button type="button" id="copy-apikey-btn" class="primary">Copy to Clipboard</button>
                    <button type="button" id="close-apikey-display-btn" class="secondary">Close</button>
                </div>
            </div>
        </section>

        <!-- Analytics Dashboard Section -->
        <section id="analytics" class="view-panel" role="tabpanel" aria-label="Analytics Dashboard" hidden>
            <h2><span aria-hidden="true">üìä</span> Analytics Dashboard</h2>
            <p class="small" style="margin-bottom: 1rem;">View usage patterns, costs, and performance metrics.</p>
            
            <div class="toolbar">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="analytics-time-range">Time Range</label>
                        <select id="analytics-time-range">
                            <option value="1h">Last Hour</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="field" id="analytics-custom-range" style="display: none;">
                        <label for="analytics-start-time">Start</label>
                        <input type="datetime-local" id="analytics-start-time">
                        <label for="analytics-end-time">End</label>
                        <input type="datetime-local" id="analytics-end-time">
                    </div>
                    <button type="button" id="refresh-analytics-btn" class="primary">Refresh</button>
                    <button type="button" id="export-stats-json-btn" class="secondary">Export Stats (JSON)</button>
                    <button type="button" id="export-stats-csv-btn" class="secondary">Export Stats (CSV)</button>
                    <button type="button" id="export-logs-csv-btn" class="secondary">Export Logs (CSV)</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="analytics-summary">
                <div class="analytics-card">
                    <h3>Total Requests</h3>
                    <div class="analytics-value" id="analytics-total-requests">-</div>
                    <div class="analytics-label">requests</div>
                </div>
                <div class="analytics-card">
                    <h3>Total Tokens</h3>
                    <div class="analytics-value" id="analytics-total-tokens">-</div>
                    <div class="analytics-label">tokens</div>
                </div>
                <div class="analytics-card">
                    <h3>Total Cost</h3>
                    <div class="analytics-value" id="analytics-total-cost">-</div>
                    <div class="analytics-label">USD</div>
                </div>
                <div class="analytics-card">
                    <h3>Avg Latency</h3>
                    <div class="analytics-value" id="analytics-avg-latency">-</div>
                    <div class="analytics-label">ms</div>
                </div>
                <div class="analytics-card">
                    <h3>Error Rate</h3>
                    <div id="analytics-error-gauge" style="display:flex;justify-content:center;"></div>
                </div>
            </div>

            <!-- Provider Overview ‚Äî donuts + bars -->
            <div class="analytics-section">
                <h3>Provider Overview</h3>
                <div class="analytics-charts" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="chart-container" style="display:flex;flex-direction:column;align-items:center;">
                        <h4>Requests by Provider</h4>
                        <div id="d3-donut-requests-provider"></div>
                    </div>
                    <div class="chart-container" style="display:flex;flex-direction:column;align-items:center;">
                        <h4>Tokens by Provider</h4>
                        <div id="d3-donut-tokens-provider"></div>
                    </div>
                    <div class="chart-container">
                        <h4>Avg Latency by Provider</h4>
                        <div id="d3-bar-latency-provider" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- Agent Workload -->
            <div class="analytics-section">
                <h3>Agent Workload</h3>
                <div class="analytics-charts">
                    <div class="chart-container">
                        <h4>Requests by Agent</h4>
                        <div id="d3-bar-requests-agent" class="chart"></div>
                    </div>
                    <div class="chart-container">
                        <h4>Tokens by Agent</h4>
                        <div id="d3-bar-tokens-agent" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- Cost Breakdown (kept for when pricing is configured) -->
            <div class="analytics-section">
                <h3>Cost Breakdown</h3>
                <p class="small" style="margin-bottom:1rem;">Cost tracking is active. Configure <code>cost_per_token</code> on providers to see real costs.</p>
                <div class="analytics-charts">
                    <div class="chart-container">
                        <h4>Cost by Provider</h4>
                        <div id="chart-cost-by-provider" class="chart"></div>
                    </div>
                    <div class="chart-container">
                        <h4>Cost by Agent</h4>
                        <div id="chart-cost-by-user" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- Batching Recommendations -->
            <div class="analytics-section">
                <h3>Batching Recommendations</h3>
                <p class="small" style="margin-bottom: 1rem;">Identify batchable request bursts and potential efficiency gains.</p>
                <div class="analytics-summary">
                    <div class="analytics-card">
                        <h3>Batchable Requests</h3>
                        <div class="analytics-value" id="analytics-batching-requests">-</div>
                        <div class="analytics-label">requests</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Recommended Batches</h3>
                        <div class="analytics-value" id="analytics-batching-batches">-</div>
                        <div class="analytics-label">batches</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Est. Savings</h3>
                        <div class="analytics-value" id="analytics-batching-savings">-</div>
                        <div class="analytics-label">USD</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Avg Batch Size</h3>
                        <div class="analytics-value" id="analytics-batching-batch-size">-</div>
                        <div class="analytics-label">requests</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Provider</th>
                            <th>Requests</th>
                            <th>Batch Size</th>
                            <th>Est. Savings</th>
                            <th>Window</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-batching-table">
                        <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Detailed Table -->
            <div class="analytics-section">
                <h3>Detailed Breakdown</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Provider / User</th>
                            <th>Requests</th>
                            <th>Tokens</th>
                            <th>Cost (USD)</th>
                            <th>Avg Latency (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-details-table">
                        <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Motivations Dashboard Section -->
        <section id="motivations" class="view-panel" role="tabpanel" aria-label="Motivations Dashboard" hidden>
            <h2><span aria-hidden="true">‚ö°</span> Motivations Dashboard</h2>
            <p class="small" style="margin-bottom: 1rem;">View and manage agent motivation triggers.</p>
            
            <div class="toolbar">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="motivation-type-filter">Type</label>
                        <select id="motivation-type-filter">
                            <option value="">All Types</option>
                            <option value="calendar">Calendar</option>
                            <option value="event">Event</option>
                            <option value="threshold">Threshold</option>
                            <option value="idle">Idle</option>
                            <option value="external">External</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="motivation-role-filter">Agent Role</label>
                        <select id="motivation-role-filter">
                            <option value="">All Roles</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="motivation-status-filter">Status</label>
                        <select id="motivation-status-filter">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    <button type="button" id="refresh-motivations-btn" class="secondary">Refresh</button>
                </div>
            </div>

            <!-- System Idle Status -->
            <div class="analytics-summary" style="margin-bottom: 1.5rem;">
                <div class="analytics-card">
                    <h3>System Status</h3>
                    <div class="analytics-value" id="motivation-system-idle">-</div>
                    <div class="analytics-label" id="motivation-idle-label">Loading...</div>
                </div>
                <div class="analytics-card">
                    <h3>Total Motivations</h3>
                    <div class="analytics-value" id="motivation-total-count">-</div>
                    <div class="analytics-label">registered</div>
                </div>
                <div class="analytics-card">
                    <h3>Active</h3>
                    <div class="analytics-value" id="motivation-active-count">-</div>
                    <div class="analytics-label">enabled</div>
                </div>
                <div class="analytics-card">
                    <h3>Recent Triggers</h3>
                    <div class="analytics-value" id="motivation-recent-triggers">-</div>
                    <div class="analytics-label">last 24h</div>
                </div>
            </div>

            <!-- Motivations by Role -->
            <div class="analytics-section">
                <h3>Motivations by Agent Role</h3>
                <div id="motivations-by-role" class="motivation-role-grid"></div>
            </div>

            <!-- All Motivations Table -->
            <div class="analytics-section">
                <h3>All Motivations</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Condition</th>
                            <th>Agent Role</th>
                            <th>Priority</th>
                            <th>Cooldown</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="motivations-table-body">
                        <tr><td colspan="8" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Recent Trigger History -->
            <div class="analytics-section">
                <h3>Recent Trigger History</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Motivation</th>
                            <th>Agent Role</th>
                            <th>Triggered At</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody id="motivation-history-table">
                        <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Diagrams Section -->
        <section id="diagrams" class="view-panel" role="tabpanel" aria-label="Workflow Diagrams" hidden>
            <h2><span aria-hidden="true">üìä</span> Workflow Diagrams</h2>
            <p class="small" style="margin-bottom: 1rem;">Interactive visualization of projects, agents, beads, and motivations.</p>

            <div class="toolbar">
                <div class="toolbar-row">
                    <div class="field">
                        <label for="diagram-type-select">Diagram Type</label>
                        <select id="diagram-type-select">
                            <option value="hierarchy">Project Hierarchy</option>
                            <option value="motivation">Motivation Flow</option>
                            <option value="message">Message Flow</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="diagram-project-filter">Project Filter</label>
                        <select id="diagram-project-filter">
                            <option value="all">All Projects</option>
                        </select>
                    </div>
                    <div class="field">
                        <label><input type="checkbox" id="diagram-auto-refresh" checked> Auto-refresh</label>
                    </div>
                    <div class="field">
                        <button type="button" id="diagram-reset-view" class="secondary">Reset View</button>
                        <button type="button" id="diagram-export-png" class="secondary">Export PNG</button>
                        <button type="button" id="diagram-export-svg" class="secondary">Export SVG</button>
                    </div>
                </div>
            </div>

            <div class="diagram-layout">
                <div class="diagram-main">
                    <div id="diagram-canvas" class="diagram-canvas"></div>
                    <div class="diagram-legend" id="diagram-legend">
                        <h4>Legend</h4>
                        <div class="legend-items">
                            <div class="legend-item" id="legend-hierarchy">
                                <span class="legend-color" style="background: #3b82f6;"></span> Project
                                <span class="legend-color" style="background: #10b981;"></span> Agent
                                <span class="legend-color" style="background: #e5e7eb;"></span> Bead
                            </div>
                            <div class="legend-item" id="legend-motivation" style="display: none;">
                                <span class="legend-color" style="background: #f59e0b;"></span> Motivation
                                <span class="legend-color" style="background: #10b981;"></span> Role
                                <span class="legend-color" style="background: #ec4899;"></span> Action
                            </div>
                            <div class="legend-item" id="legend-message" style="display: none;">
                                <span class="legend-color" style="background: #6366f1;"></span> Component
                                <span class="legend-color" style="background: #14b8a6;"></span> Event
                            </div>
                        </div>
                    </div>
                </div>
                <div id="diagram-details" class="diagram-details" style="display: none;">
                    <!-- Node details will appear here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Modal for spawning agents -->
    <div id="spawn-agent-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="spawn-agent-modal-title" aria-hidden="true" tabindex="-1">
        <div class="modal-content">
            <button type="button" class="close" onclick="closeSpawnAgentModal()" aria-label="Close dialog">&times;</button>
            <h2 id="spawn-agent-modal-title">Spawn New Agent</h2>
            <form id="spawn-agent-form">
                <label for="agent-name">Agent Name (optional):</label>
                <input type="text" id="agent-name" name="name">
                
                <label for="agent-persona">Persona:</label>
                <select id="agent-persona" name="persona_name" required>
                    <!-- Options loaded dynamically -->
                </select>
                
                <label for="agent-project">Project:</label>
                <select id="agent-project" name="project_id" required>
                    <!-- Options loaded dynamically -->
                </select>

                <label for="agent-provider">Provider:</label>
                <select id="agent-provider" name="provider_id" required>
                    <!-- Options loaded dynamically -->
                </select>
                
                <button type="submit">Spawn Agent</button>
            </form>
        </div>
    </div>

    <!-- Modal for viewing/editing persona -->
    <div id="persona-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="persona-modal-title" aria-hidden="true" tabindex="-1">
        <div class="modal-content large">
            <button type="button" class="close" onclick="closePersonaModal()" aria-label="Close dialog">&times;</button>
            <h2 id="persona-modal-title">Persona Editor</h2>
            <div id="persona-editor">
                <!-- Persona editor will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Generic modal for confirmations/details/forms -->
    <div id="app-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="app-modal-title" aria-hidden="true" tabindex="-1">
        <div class="modal-content">
            <button type="button" class="close" onclick="closeAppModal()" aria-label="Close dialog">&times;</button>
            <h2 id="app-modal-title">Dialog</h2>
            <div id="app-modal-body"></div>
            <div id="app-modal-actions" class="modal-actions"></div>
        </div>
    </div>

    <!-- Pair-Programming Panel (slide-out right panel) -->
    <div id="pair-panel" class="pair-panel" role="complementary" aria-label="Pair Programming">
        <div class="pair-header">
            <div class="pair-header-info">
                <strong>Pair Programming</strong>
                <span id="pair-bead-info" class="pair-bead-id"></span>
            </div>
            <div class="pair-header-controls">
                <select id="pair-agent-select" aria-label="Select agent"></select>
                <button type="button" id="pair-close-btn" class="secondary" aria-label="Close pair panel">Close</button>
            </div>
        </div>
        <div id="pair-messages" class="pair-messages"></div>
        <div class="pair-input-area">
            <textarea id="pair-input" rows="2" placeholder="Type a message... (Enter to send, Shift+Enter for newline)" aria-label="Chat message"></textarea>
            <button type="button" id="pair-send-btn" class="primary">Send</button>
        </div>
    </div>

    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <footer>
        <p>Loom v1.0.0 | <a href="/api/v1/health">API Health</a> | <a href="/api/openapi.yaml">OpenAPI Spec</a></p>
    </footer>

    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
    <script src="/static/js/d3-charts.js?v=1"></script>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-svg@0.4.0/cytoscape-svg.js"></script>
    <script src="/static/js/app.js?v=19"></script>
    <script src="/static/js/logs.js?v=6"></script>
    <script src="/static/js/diagrams.js?v=3"></script>

    <!-- Hot-reload client (development only) -->
    <script src="/static/js/hotreload.js?v=3"></script>
</body>
</html>
