id: "wf-bug-default"
name: "Bug Fix Workflow"
description: "Default workflow for auto-filed bugs and error reports"
workflow_type: "bug"
is_default: true

nodes:
  - node_key: "investigate"
    node_type: "task"
    role_required: "QA"
    persona_hint: "default/qa"
    max_attempts: 3
    timeout_minutes: 60
    instructions: |
      Investigate this bug by:
      1. Searching codebase for related code
      2. Reading relevant files
      3. Analyzing root cause
      4. Proposing a fix
      5. Creating an approval bead with your findings

  - node_key: "pm_review"
    node_type: "approval"
    role_required: "Product Manager"
    persona_hint: "default/product-manager"
    max_attempts: 1
    timeout_minutes: 120
    instructions: |
      Review the investigation findings and proposed fix:
      1. Assess impact and risk
      2. Verify proposed fix addresses root cause
      3. Approve or reject with feedback

  - node_key: "apply_fix"
    node_type: "task"
    role_required: "Engineering Manager"
    persona_hint: "default/engineering-manager"
    max_attempts: 2
    timeout_minutes: 30
    instructions: |
      Apply the approved fix:
      1. Apply the patch to the codebase
      2. Verify the fix works
      3. Create a commit with descriptive message

  - node_key: "commit_and_push"
    node_type: "commit"
    role_required: "Engineering Manager"
    persona_hint: "default/engineering-manager"
    max_attempts: 2
    timeout_minutes: 15
    instructions: |
      Commit and push the fix:
      1. Ensure all changes are staged
      2. Create commit with proper message
      3. Push to remote repository

edges:
  # Start → investigate
  - from_node_key: ""
    to_node_key: "investigate"
    condition: "success"
    priority: 100

  # investigate → pm_review (on success)
  - from_node_key: "investigate"
    to_node_key: "pm_review"
    condition: "success"
    priority: 100

  # investigate → escalate (on failure after max attempts)
  - from_node_key: "investigate"
    to_node_key: ""
    condition: "escalated"
    priority: 90

  # pm_review → apply_fix (on approval)
  - from_node_key: "pm_review"
    to_node_key: "apply_fix"
    condition: "approved"
    priority: 100

  # pm_review → investigate (on rejection - retry with feedback)
  - from_node_key: "pm_review"
    to_node_key: "investigate"
    condition: "rejected"
    priority: 100

  # apply_fix → commit_and_push (on success)
  - from_node_key: "apply_fix"
    to_node_key: "commit_and_push"
    condition: "success"
    priority: 100

  # apply_fix → investigate (on failure - need new approach)
  - from_node_key: "apply_fix"
    to_node_key: "investigate"
    condition: "failure"
    priority: 100

  # commit_and_push → end (on success)
  - from_node_key: "commit_and_push"
    to_node_key: ""
    condition: "success"
    priority: 100

  # commit_and_push → apply_fix (on failure - retry)
  - from_node_key: "commit_and_push"
    to_node_key: "apply_fix"
    condition: "failure"
    priority: 100
