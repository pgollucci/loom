# Loom Configuration

# The project ID for loom's own self-managed repository (the project loom uses to track its own work)
self_project_id: loom

server:
  http_port: 8081
  https_port: 8443
  enable_http: true
  enable_https: false
  tls_cert_file: ""  # Path to TLS certificate (when ready)
  tls_key_file: ""   # Path to TLS key (when ready)
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s

database:
  type: sqlite
  path: ./data/loom.db  # Resolves to /app/data/loom.db in container, ./data/loom.db natively

beads:
  bd_path: bd  # Path to bd executable
  auto_sync: true
  sync_interval: 5m
  compact_old_days: 90  # Compact closed beads older than 90 days
  backend: yaml          # Use YAML files directly for git-centric storage
  beads_branch: "beads-sync"    # Global default for beads branch
  use_git_storage: true         # Enable git-centric storage
  federation:
    enabled: true        # Enable git-based federation
    auto_sync: true
    sync_interval: 30s   # Pull beads-sync branch every 30 seconds
    sync_strategy: ours
    sync_mode: git-native  # Changed from dolt-native
    peers: []            # Add peers via API or config for multi-container sync

agents:
  max_concurrent: 12
  default_persona_path: ./personas
  heartbeat_interval: 30s
  file_lock_timeout: 10m
  allowed_roles:
    - ceo
    - engineering-manager
    - project-manager
    - product-manager
    - code-reviewer
    - qa-engineer
    - devops-engineer
    - remediation-specialist
    - public-relations-manager

dispatch:
  max_hops: 20
  use_nats_dispatch: true  # Route tasks to per-project containers via NATS when containers are running

pda:
  enabled: true           # Enable Plan/Document/Act orchestrator
  planner_model: ""       # Auto-detected from active providers
  planner_endpoint: ""    # Auto-detected from active providers
  planner_api_key: ""

swarm:
  enabled: true           # Enable dynamic swarm membership
  peer_nats_urls: []      # URLs of peer Loom NATS instances for federation
  gateway_name: "loom-primary"

git:
  project_key_dir: /app/data/projects

security:
  enable_auth: false  # Disabled for development - enable for production
  pki_enabled: false  # Will be enabled when certificates are provided
  ca_file: ""
  require_https: false
  jwt_secret: "change-me-in-production"
  allowed_origins:
    - "*"  # CORS - adjust in production
  # api_keys:
  #   - "your-api-key-here"
  openclaw_enabled: false  # Per-project opt-in for openclaw integration

cache:
  enabled: true               # Enable response caching
  default_ttl: 1h             # Default time-to-live for cache entries
  max_size: 10000             # Maximum number of cached entries
  max_memory_mb: 500          # Maximum memory usage (approximate)
  cleanup_period: 5m          # How often to clean expired entries

# Model preferences for provider negotiation.
# When a provider returns multiple models, Loom selects the best match from this list.
# When a provider returns only one model (single-model servers like Ollama), it uses that directly.
# Models are ranked from most preferred (rank 1) to adequate fallbacks.
models:
  preferred_models:
    # Tier 1: Extended thinking / Complex reasoning (70B+ or advanced MoE)
    - name: "anthropic/claude-opus-4"
      rank: 1
      tier: extended
      min_vram_gb: 0  # Cloud-only
      notes: "Best for complex reasoning, architecture decisions"
    - name: "Qwen/Qwen3-Coder-480B-A35B-Instruct"
      rank: 2
      tier: extended
      min_vram_gb: 320
      notes: "MoE with 35B active params, exceptional code quality"
    
    # Tier 2: Complex tasks (30-70B)
    - name: "anthropic/claude-sonnet-4"
      rank: 10
      tier: complex
      min_vram_gb: 0
      notes: "Excellent balance of capability and speed"
    - name: "Qwen/Qwen3-Coder-480B-A35B-Instruct"
      rank: 11
      tier: complex
      min_vram_gb: 64
      notes: "Strong code generation, fits on single high-end GPU"
    - name: "deepseek-ai/DeepSeek-Coder-V2-Instruct"
      rank: 12
      tier: complex
      min_vram_gb: 48
      notes: "MoE architecture, excellent for code"
    - name: "Qwen/Qwen3-Coder-30B-A3B-Instruct"
      rank: 13
      tier: complex
      min_vram_gb: 48
      notes: "MoE with 3B active, fast for size"
    - name: "nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-FP8"
      rank: 14
      tier: complex
      min_vram_gb: 24
      notes: "NVIDIA optimized, good throughput"
    
    # Tier 3: Medium tasks (14-30B)
    - name: "Qwen/Qwen2.5-Coder-14B-Instruct"
      rank: 20
      tier: medium
      min_vram_gb: 28
      notes: "Good balance for everyday coding tasks"
    - name: "deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct"
      rank: 21
      tier: medium
      min_vram_gb: 10
      notes: "16B MoE with only 2.4B active, very efficient"
    - name: "meta-llama/Llama-3.1-70B-Instruct"
      rank: 22
      tier: medium
      min_vram_gb: 140
      notes: "Strong general reasoning"
    
    # Tier 4: Simple tasks (7-14B) - fast response for reviews, checks
    - name: "Qwen/Qwen2.5-Coder-7B-Instruct"
      rank: 30
      tier: simple
      min_vram_gb: 14
      notes: "Fast, good for simple code tasks"
    - name: "mistralai/Mistral-7B-Instruct-v0.3"
      rank: 31
      tier: simple
      min_vram_gb: 14
      notes: "Fast general-purpose chat"
    - name: "meta-llama/Llama-3.1-8B-Instruct"
      rank: 32
      tier: simple
      min_vram_gb: 16
      notes: "Meta's compact instruct model"
    - name: "Qwen/Qwen2.5-3B-Instruct"
      rank: 33
      tier: simple
      min_vram_gb: 6
      notes: "Ultra-fast for trivial tasks"

providers: []
  # Providers are registered via API, not in this file.
  # Create a bootstrap.local file (gitignored) with curl commands:
  #   curl -X POST http://localhost:8081/api/v1/providers \
  #     -H "Content-Type: application/json" \
  #     -d '{"id":"my-provider","name":"My Provider","type":"openai",
  #          "endpoint":"http://localhost:8000/v1","model":"my-model",
  #          "api_key":"sk-..."}'
  # See bootstrap.local.example for a template.

projects:
  - id: loom
    name: Loom
    git_repo: "https://github.com/jordanhubbard/loom.git"  # HTTPS for token-based auth
    branch: develop
    beads_path: "/.beads"  # Path within beads worktree
    beads_branch: "beads-sync"  # Branch for beads storage
    use_worktrees: true  # Enable git worktree isolation
    use_container: false  # TaskExecutor runs in-process; no per-project container needed
    git_auth_method: token  # Use token authentication (GITHUB_TOKEN or GITLAB_TOKEN env var)
    git_strategy: direct
    is_perpetual: true
    is_sticky: true
    context:
      build_command: "go build"
      test_command: "go test ./..."
      description: "The Loom project itself - perpetual self-improvement"
  - id: aviation
    name: Aviation
    git_repo: "https://github.com/jordanhubbard/Aviation.git"
    branch: main
    beads_path: ".beads"
    beads_branch: "beads-sync"
    use_worktrees: true
    use_container: true
    git_auth_method: token
    git_strategy: direct
    is_perpetual: true
    is_sticky: true
    context:
      description: "Aviation project"
  - id: tokenhub
    name: TokenHub
    git_repo: "https://github.com/jordanhubbard/tokenhub.git"
    branch: main
    beads_path: ".beads"
    beads_branch: "beads-sync"
    use_worktrees: true
    use_container: true
    git_auth_method: token
    git_strategy: direct
    is_perpetual: true
    is_sticky: true
    context:
      build_command: "go build ./cmd/tokenhub"
      test_command: "go test ./..."
      description: "LLM routing proxy - provider selection, health tracking, failover, and Thompson Sampling"
  # - id: example-project
  #   name: Example Project
  #   git_repo: /path/to/repo
  #   branch: main
  #   beads_path: data/.beads  # Store in persisted volume
  #   context:
  #     build_command: "make build"
  #     test_command: "make test"

web_ui:
  enabled: true
  static_path: ./web/static
  refresh_interval: 5  # seconds

hot_reload:
  enabled: true  # Enable hot-reload for development
  watch_dirs:
    - "./web/static"  # Watch frontend files
    - "./personas"    # Watch persona definitions
  patterns:
    - "*.html"
    - "*.css"
    - "*.js"
    - "*.md"
    - "PERSONA.md"
