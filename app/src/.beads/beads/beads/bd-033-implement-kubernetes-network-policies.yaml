entitymetadata:
    schemaversion: ""
    attributes: {}
    migratedat: null
    migratedfrom: ""
id: bd-033
type: task
title: Implement Kubernetes Network Policies
description: |-
    Add network segmentation and zero-trust networking.

    Security benefits:
    - Limit pod-to-pod communication
    - Restrict egress traffic
    - Defense in depth
    - Compliance requirements

    Implementation:
    1. Enable network policies in cluster (CNI support)
    2. Create k8s/network-policy.yaml
    3. Define ingress rules (allow from ingress-nginx)
    4. Define egress rules:
       - Allow DNS (kube-system)
       - Allow Temporal (port 7233)
       - Allow database (port 5432)
       - Allow HTTPS for git/providers (port 443)
    5. Test thoroughly (can break unexpected dependencies)
    6. Document allowed connections

    Deliverables:
    - NetworkPolicy manifests
    - Connection diagram
    - Testing documentation
status: in_progress
priority: 2
projectid: agenticorp-self
assignedto: agent-1769138560-Code Reviewer (Default)
blockedby: []
blocks: []
relatedto: []
parent: ""
children: []
tags: []
context:
    agent_id: agent-1769138560-Code Reviewer (Default)
    agent_output: "We need to produce output in specified format: short plan, key questions/risks, concrete next actions, proposed patch snippets if applicable. Must follow bead instructions. Provide plan for implementing Kubernetes Network Policies. Should be thorough, security-first, etc. Provide plan steps. Provide key questions/risks. Provide concrete next actions: commands/files to change. Provide patch snippets. Should be concise but thorough. Use format.\n</think>\n**1) Short Plan**  \n- Verify CNI supports NetworkPolicies (Calico/Weave).  \n- Create `k8s/network-policy.yaml` with:  \n  - **Ingress**: allow only `ingress-nginx` namespace pods.  \n  - **Egress**: allow DNS (kube-system), Temporal (port 7233), PostgreSQL (port 5432), HTTPS (port 443).  \n  - Default deny all other traffic.  \n- Apply the policy with `kubectl apply -f`.  \n- Run `go test ./...` to ensure no unexpected network breaks.  \n- Document allowed connections in `README-NETWORK-POLICY.md` and sketch a connection diagram.  \n\n**2) Key Questions / Risks**  \n- **CNI compatibility** – Some CNIs (e.g., basic kube‑proxy only) ignore NetworkPolicy; we must confirm the cluster’s CNI is policy‑aware.  \n- **Existing dependencies** – Which pods currently talk to each other that we might unintentionally block? (e.g., side‑car containers, init containers).  \n- **Port exposure** – Are the target services (Temporal, PostgreSQL) exposed via ClusterIP only, or also via LoadBalancer/NodePort?  \n- **Testing impact** – Will CI pipelines or external health‑checks lose connectivity after the policy is enforced?  \n- **Namespace scope** – Should the policy be namespace‑specific or cluster‑wide?  \n- **Future changes** – How will new services be added without breaking the zero‑trust model?  \n\n**3) Concrete Next Actions**  \n\n| Step | Command / File | Details |\n|------|----------------|---------|\n| **A. Verify CNI** | `kubectl get pods -n kube-system -l k8s-app=calico-node` (or equivalent for Weave) | Ensure the CNI is running and supports `NetworkPolicy`. |\n| **B. Create policy file** | `mkdir -p k8s && touch k8s/network-policy.yaml` | Populate with the manifest shown below. |\n| **C. Apply policy** | `kubectl apply -f k8s/network-policy.yaml` | Observe any admission errors. |\n| **D. Test connectivity** | `go test ./...` (run after policy applied) | Confirm no test failures due to network. |\n| **E. Document** | `docs/NETWORK-POLICY.md` | Write allowed‑connection list and diagram. |\n| **F. Verify** | `kubectl describe networkpolicy -f k8s/network-policy.yaml` | Ensure rules are correctly parsed. |\n\n**4) Proposed Patch Snippets**  \n\n*`k8s/network-policy.yaml`*  \n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-ingress-nginx-and-allowed-egress\n  namespace: default   # adjust if using a dedicated namespace\nspec:\n  podSelector: {}       # applies to all pods in the namespace\n  policyTypes:\n  - Ingress\n  - Egress\n\n  # ---------- Ingress ----------\n  ingress:\n  - from:\n    - namespaceSelector:\n        matchLabels:\n          name: ingress-nginx\n    ports:\n    - protocol: TCP\n      port: 80\n    - protocol: TCP\n      port: 443\n\n  # ---------- Egress ----------\n  egress:\n  # DNS (UDP/TCP 53) – kube-system namespace\n  - to:\n    - namespaceSelector:\n        matchLabels:\n          k8s-app: kube-dns\n    ports:\n    - protocol: UDP\n      port: 53\n    - protocol: TCP\n      port: 53\n\n  # Temporal gRPC (port 7233)\n  - to:\n    - podSelector:\n        matchLabels:\n          app: temporal\n    ports:\n    - protocol: TCP\n      port: 7233\n\n  # PostgreSQL (port 5432)\n  - to:\n    - podSelector:\n        matchLabels:\n          app: postgres\n    ports:\n    - protocol: TCP\n      port: 5432\n\n  # HTTPS for git providers (port 443)\n  - to:\n    - namespaceSelector:\n        matchLabels:\n          app.kubernetes.io/name: git-providers\n    ports:\n    - protocol: TCP\n      port: 443\n\n  # Default deny (implicit when no rule matches)\n```\n\n*Optional*: If the project uses a dedicated namespace (e.g., `agenticorp-system`), replace `namespace: default` with that namespace and add `namespaceSelector` for the target services accordingly.\n\n**Next Step**: Run the verification command from **Step A** to confirm CNI supports policies before proceeding to manifest creation. If the CNI does not support NetworkPolicy, we must either upgrade the CNI or fallback to a different segmentation strategy."
    agent_task_id: task-bd-033-1769146420019346548
    agent_tokens: "2002"
    agent_worker_id: worker-agent-1769138560-Code Reviewer (Default)-1769146419
    dispatch_history: '["agent-1769138560-Code Reviewer (Default)"]'
    last_run_at: "2026-01-23T05:33:48Z"
    loop_detected: "false"
    provider_id: puck-vllm
    provider_model: nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-FP8
    redispatch_requested: "false"
createdat: 2026-01-23T00:08:10.978467009Z
updatedat: 2026-01-23T05:33:48.719940678Z
closedat: null
